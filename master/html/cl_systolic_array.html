

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Systolic Array Implementation &mdash; Vitis Accel Examples&#39; Documentation 2019.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Vitis Accel Examples' Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="shells.html">Supported Shells</a></li>
<li class="toctree-l1"><a class="reference internal" href="compile_execute.html">Compilation and Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud.html">Cloud Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
</ul>
<p class="caption"><span class="caption-text">Category of Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="hello_world.html">Hello World</a></li>
<li class="toctree-l1"><a class="reference internal" href="host.html">Host</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp.html">C++ Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="sys_opt.html">System Optimization Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="rtl.html">RTL Kernels</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="ocl.html">OpenCL Kernels</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cl_array_partition.html">Array Partitioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="cl_burst_rw.html">Burst Read/Write</a></li>
<li class="toctree-l2"><a class="reference internal" href="cl_dataflow_func.html">Dataflow Function OpenCL</a></li>
<li class="toctree-l2"><a class="reference internal" href="cl_dataflow_subfunc.html">Dataflow SubFunction OpenCL</a></li>
<li class="toctree-l2"><a class="reference internal" href="cl_gmem_2banks.html">Global Memory Two Banks</a></li>
<li class="toctree-l2"><a class="reference internal" href="cl_helloworld.html">Hello World</a></li>
<li class="toctree-l2"><a class="reference internal" href="cl_lmem_2rw.html">Two Parallel Read/Write on Local Memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="cl_loop_reorder.html">Loop Reorder for better Performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="cl_partition_cyclicblock.html">Array Block and Cyclic Partitioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="cl_shift_register.html">Shift Register</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Systolic Array Implementation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#supported-shells">SUPPORTED SHELLS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#design-files">DESIGN FILES</a></li>
<li class="toctree-l3"><a class="reference internal" href="#command-line-arguments">COMMAND LINE ARGUMENTS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cl_wide_mem_rw.html">Wide Memory Read/Write</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Common Utilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="common.html">Common Files</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Vitis Accel Examples' Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="ocl.html">OpenCL Kernels</a> &raquo;</li>
        
      <li>Systolic Array Implementation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/cl_systolic_array.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="systolic-array-implementation">
<h1>Systolic Array Implementation<a class="headerlink" href="#systolic-array-implementation" title="Permalink to this headline">Â¶</a></h1>
<p>This is a simple example of matrix multiplication (Row x Col) to help
developers learn systolic array based algorithm design. Note: Systolic
array based algorithm design is well suited for FPGA.</p>
<p>This example demonstrates how <code class="docutils literal notranslate"><span class="pre">Systolic</span> <span class="pre">array</span> <span class="pre">algorithm</span></code> can be used
in FPGAs to perform matrix operations efficiently.</p>
<p>Matrix multiplication is performed in the <code class="docutils literal notranslate"><span class="pre">mmult</span></code> kernel. Local
matrices A and B are partitioned using attribute <code class="docutils literal notranslate"><span class="pre">xcl_array_partition</span></code>
along rows and columns respectively for computation of each element of
the matrix C requires a row of matrix A and a column of matrix B. Matrix
C is partitioned completely.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">localA</span><span class="p">[</span><span class="n">MAX_SIZE</span><span class="p">][</span><span class="n">MAX_SIZE</span><span class="p">]</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">xcl_array_partition</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));;</span>
   <span class="kt">int</span> <span class="n">localB</span><span class="p">[</span><span class="n">MAX_SIZE</span><span class="p">][</span><span class="n">MAX_SIZE</span><span class="p">]</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">xcl_array_partition</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="mi">2</span><span class="p">)));;</span>
   <span class="kt">int</span> <span class="n">localC</span><span class="p">[</span><span class="n">MAX_SIZE</span><span class="p">][</span><span class="n">MAX_SIZE</span><span class="p">]</span>  <span class="n">__attribute__</span><span class="p">((</span><span class="n">xcl_array_partition</span><span class="p">(</span><span class="n">complete</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));;</span>
</pre></div>
</div>
<p>This allows the multiply and accumulate operations in the below code to
be performed in parallel thus speeding up the operation as innermost
loop is unrolled to provide for the pipelining in the outer loops.
However, the number of these parallel operations is limited by the
number of DSPs available in the FPGA.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="nl">systolic1</span><span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">a_col</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__attribute__</span><span class="p">((</span><span class="n">xcl_loop_tripcount</span><span class="p">(</span><span class="n">c_size</span><span class="p">,</span> <span class="n">c_size</span><span class="p">)))</span>
        <span class="nl">systolic2</span><span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">__attribute__</span><span class="p">((</span><span class="n">xcl_loop_tripcount</span><span class="p">(</span><span class="n">c_size</span><span class="p">,</span> <span class="n">c_size</span><span class="p">)))</span>
            <span class="nl">systolic3</span><span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">localC</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
                <span class="kt">int</span> <span class="n">a_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">a_row</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">a_col</span><span class="p">)</span><span class="o">?</span> <span class="n">localA</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">b_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">b_row</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">b_col</span><span class="p">)</span><span class="o">?</span> <span class="n">localB</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">last</span> <span class="o">+</span> <span class="n">a_val</span><span class="o">*</span><span class="n">b_val</span><span class="p">;</span>

                <span class="n">localC</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
<div class="section" id="supported-shells">
<h2>SUPPORTED SHELLS<a class="headerlink" href="#supported-shells" title="Permalink to this headline">Â¶</a></h2>
<table class="docutils align-center">
<colgroup>
<col style="width: 38%" />
<col style="width: 32%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>SHELL</p></th>
<th class="head"><p>Board</p></th>
<th class="head"><p>Software Version</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>xilinx_u200_qdma</p></td>
<td><p>Xilinx Alveo U200</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
<tr class="row-odd"><td><p>xilinx_u280_xdma</p></td>
<td><p>Xilinx Alveo U280</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
<tr class="row-even"><td><p>xilinx_u250_qdma</p></td>
<td><p>Xilinx Alveo U250</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
<tr class="row-odd"><td><p>xilinx_u200_xdma</p></td>
<td><p>Xilinx Alveo U200</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
<tr class="row-even"><td><p>xilinx_u250_xdma</p></td>
<td><p>Xilinx Alveo U250</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
<tr class="row-odd"><td><p>xilinx_u280-es1_xdma</p></td>
<td><p>Xilinx Alveo U280</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="design-files">
<h2>DESIGN FILES<a class="headerlink" href="#design-files" title="Permalink to this headline">Â¶</a></h2>
<p>Application code is located in the src directory. Accelerator binary
files will be compiled to the xclbin directory. The xclbin directory is
required by the Makefile and its contents will be filled during
compilation. A listing of all the files in this example is shown below</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">src</span><span class="o">/</span><span class="n">host</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">src</span><span class="o">/</span><span class="n">mmult</span><span class="o">.</span><span class="n">cl</span>
</pre></div>
</div>
</div>
<div class="section" id="command-line-arguments">
<h2>COMMAND LINE ARGUMENTS<a class="headerlink" href="#command-line-arguments" title="Permalink to this headline">Â¶</a></h2>
<p>Once the environment has been configured, the application can be
executed by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">host</span> <span class="o">&lt;</span><span class="n">mmult</span> <span class="n">XCLBIN</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Xilinx Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>